#' Generate frequency / proportions table from survey data
#'
#' @param dat A dataframe containing the variables to be used as rows and
#' columns in the output table.
#' @param row_vars Character vector containing the variables to be used as rows
#' in the table.
#' @param col_var Character string containing the variables ot be used as
#' columns in the output table.
#' @param variable_labels A dataframe consisting of 2 columns:
#' 1. variable - the variable names of `dat`
#' 2. label - the variable labels of `dat`
#' As generated by \link[tveDataLoader]{get_varLabels}
#' @param perecents TRUE if column percents required, FALSE If counts required.
#'
#' @export
generate_table <- function(dat,
                           row_vars,
                           col_var,
                           variable_labels,
                           percents = FALSE) {

  out <- select(dat, all_of(c(row_vars, col_var))) %>%
    # if labelled convert to ordered factor
    mutate(across(where(is.labelled), ~haven::as_factor(.x, ordered = TRUE))) %>%
    mutate(across(where(~!is.factor(.x)), ~factor(.x, levels = sort(unique(.x))))) %>%
    mutate(across(everything(), forcats::fct_explicit_na)) %>%
    mutate(across(everything(), as.character)) %>%
    pivot_longer(-all_of(col_var)) %>%
    group_by(across(everything())) %>%
    count() %>%
    ungroup() %>%
    pivot_wider(names_from = all_of(col_var), values_from = n) %>%
    left_join(variable_labels, by = c("name" = "variable")) %>%
    relocate(label, .after = name)

  if(percents == TRUE) {
    out <- out %>%
      group_by(name) %>%
      mutate(across(-c(1:2), ~.x / sum(.x, na.rm = TRUE), 0))
  }


  names(out) <- c("Variable", "Label", "Value", names(out)[-c(1:3)])

  return(out)
}
